<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sudoku</title>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --border-thick: #60a5fa;
            --cell-bg: #1e293b;
            --cell-given: #f1f5f9;
            --cell-user: #60a5fa;
            --cell-error: #ef4444;
            --cell-highlight: rgba(59, 130, 246, 0.08);
            --cell-same: rgba(59, 130, 246, 0.18);
            --cell-selected: #2563eb;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --btn-bg: #334155;
            --btn-hover: #475569;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --notes-color: #94a3b8;
            --progress-bg: #1e293b;
            --progress-fill: #3b82f6;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 450px;
            margin-bottom: 12px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .info-row {
            display: flex;
            gap: 16px;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .info-row span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .difficulty-select {
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            outline: none;
            transition: border-color 0.15s;
        }

        .difficulty-select:focus {
            border-color: var(--accent);
        }

        .pause-btn {
            background: var(--btn-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.15s;
            line-height: 1;
        }

        .pause-btn:hover {
            background: var(--btn-hover);
        }

        /* ---- PROGRESS BAR ---- */
        .progress-wrapper {
            width: 100%;
            max-width: 450px;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--progress-bg);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #a78bfa);
            border-radius: 2px;
            transition: width 0.4s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 2px;
        }

        /* ---- BOARD ---- */
        .board-wrapper {
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1 / 1;
            position: relative;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%;
            height: 100%;
            border: 2px solid var(--border-thick);
            border-radius: 10px;
            overflow: hidden;
        }

        /* Pause overlay */
        .pause-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            z-index: 10;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            cursor: pointer;
        }

        .pause-overlay.show {
            display: flex;
        }

        .pause-overlay span {
            font-size: 3rem;
        }

        .pause-overlay p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1rem, 3.5vw, 1.6rem);
            font-weight: 600;
            background: var(--cell-bg);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s, transform 0.15s;
            aspect-ratio: 1/1;
        }

        /* thick borders for 3x3 boxes */
        .cell[data-col="2"],
        .cell[data-col="5"] {
            border-right: 2px solid var(--border-thick);
        }

        .cell[data-row="2"],
        .cell[data-row="5"] {
            border-bottom: 2px solid var(--border-thick);
        }

        .cell.given {
            color: var(--cell-given);
        }

        .cell.user {
            color: var(--cell-user);
        }

        .cell.error {
            color: var(--cell-error);
            animation: shake 0.35s;
        }

        .cell.highlight {
            background: var(--cell-highlight);
        }

        .cell.same-num {
            background: var(--cell-same);
        }

        .cell.selected {
            background: var(--cell-selected);
            box-shadow: inset 0 0 0 2px var(--accent);
            z-index: 1;
        }

        .cell.pop {
            animation: cellPop 0.25s ease;
        }

        .cell.hint-flash {
            animation: hintGlow 0.6s ease;
        }

        .cell .notes-grid {
            position: absolute;
            inset: 2px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            pointer-events: none;
        }

        .cell .notes-grid span {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.38rem, 1.2vw, 0.6rem);
            font-weight: 500;
            color: var(--notes-color);
            line-height: 1;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20% {
                transform: translateX(-3px);
            }

            40% {
                transform: translateX(3px);
            }

            60% {
                transform: translateX(-2px);
            }

            80% {
                transform: translateX(2px);
            }
        }

        @keyframes cellPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes hintGlow {
            0% {
                box-shadow: inset 0 0 0 2px var(--success);
            }

            50% {
                box-shadow: inset 0 0 12px 2px rgba(34, 197, 94, 0.4);
            }

            100% {
                box-shadow: inset 0 0 0 0px transparent;
            }
        }

        /* ---- CONTROLS ---- */
        .controls {
            width: 100%;
            max-width: 450px;
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .num-pad {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
        }

        .num-btn {
            aspect-ratio: 1/1;
            border: none;
            border-radius: 8px;
            background: var(--btn-bg);
            color: var(--text);
            font-size: clamp(1rem, 3vw, 1.3rem);
            font-weight: 700;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .num-btn:hover {
            background: var(--btn-hover);
        }

        .num-btn:active {
            transform: scale(0.93);
        }

        .num-btn.depleted {
            opacity: 0.25;
            pointer-events: none;
        }

        .num-btn.active-num {
            box-shadow: inset 0 0 0 2px var(--accent);
            background: rgba(59, 130, 246, 0.15);
        }

        .num-btn .count-badge {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: clamp(0.4rem, 1vw, 0.55rem);
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1;
        }

        .action-row {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 8px;
            background: var(--btn-bg);
            color: var(--text);
            font-size: clamp(0.72rem, 2vw, 0.88rem);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: var(--btn-hover);
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-btn.active {
            background: var(--accent);
            color: #fff;
        }

        .action-btn.new-game {
            background: var(--accent);
            color: #fff;
        }

        .action-btn.new-game:hover {
            background: var(--accent-hover);
        }

        .action-btn:disabled {
            opacity: 0.35;
            pointer-events: none;
        }

        /* ---- MODAL ---- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            max-width: 340px;
            width: 90%;
            animation: pop 0.3s ease;
        }

        .modal h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .modal h2.win {
            color: var(--success);
        }

        .modal h2.lose {
            color: var(--danger);
        }

        .modal .stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 16px;
        }

        .modal .stat {
            text-align: center;
        }

        .modal .stat-val {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
        }

        .modal .stat-label {
            font-size: 0.72rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal p {
            color: var(--text-muted);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .modal button {
            padding: 10px 28px;
            border: none;
            border-radius: 8px;
            background: var(--accent);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
        }

        .modal button:hover {
            background: var(--accent-hover);
        }

        .modal button:active {
            transform: scale(0.96);
        }

        @keyframes pop {
            0% {
                transform: scale(0.85);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ---- CONFETTI ---- */
        .confetti-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 200;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg) scale(0.3);
            }
        }

        /* ---- Responsive tweaks ---- */
        @media (max-width: 360px) {
            body {
                padding: 8px;
            }

            .controls {
                gap: 6px;
            }

            .action-btn {
                padding: 8px 0;
                gap: 3px;
            }
        }

        @media (max-height: 700px) {
            body {
                justify-content: flex-start;
                padding-top: 8px;
            }

            h1 {
                margin-bottom: 4px;
            }

            .top-bar {
                margin-bottom: 6px;
            }

            .controls {
                margin-top: 8px;
                gap: 6px;
            }

            .progress-wrapper {
                margin-bottom: 4px;
            }
        }

        @media (min-width: 600px) and (min-height: 800px) {
            .board-wrapper {
                max-width: 480px;
            }

            .controls {
                max-width: 480px;
            }

            .top-bar {
                max-width: 480px;
            }

            .progress-wrapper {
                max-width: 480px;
            }
        }

        @media (min-width: 900px) {
            .board-wrapper {
                max-width: 500px;
            }

            .controls {
                max-width: 500px;
            }

            .top-bar {
                max-width: 500px;
            }

            .progress-wrapper {
                max-width: 500px;
            }
        }
    </style>
</head>

<body>

    <h1>Sudoku</h1>

    <div class="top-bar">
        <div class="info-row">
            <span>&#9201; <span id="timer">00:00</span></span>
            <span>&#10060; <span id="mistakes">0</span>/3</span>
        </div>
        <div class="top-right">
            <button class="pause-btn" id="pauseBtn" title="Pause / Resume">&#9208;</button>
            <select class="difficulty-select" id="difficulty">
                <option value="easy">Easy</option>
                <option value="medium" selected>Medium</option>
                <option value="hard">Hard</option>
                <option value="expert">Expert</option>
            </select>
        </div>
    </div>

    <div class="progress-wrapper">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 81</div>
    </div>

    <div class="board-wrapper">
        <div class="board" id="board"></div>
        <div class="pause-overlay" id="pauseOverlay">
            <span>&#9208;</span>
            <p>Game Paused &#8212; click to resume</p>
        </div>
    </div>

    <div class="controls">
        <div class="action-row">
            <button class="action-btn" id="undoBtn" title="Undo (Ctrl+Z)">&#8617; Undo</button>
            <button class="action-btn" id="eraseBtn" title="Erase (Backspace)">&#9003; Erase</button>
            <button class="action-btn" id="notesBtn" title="Toggle Notes (N)">&#9998; Notes</button>
            <button class="action-btn" id="hintBtn" title="Get a Hint (H)">&#128161; Hint</button>
            <button class="action-btn new-game" id="newGameBtn">&#9654; New</button>
        </div>
        <div class="num-pad" id="numPad"></div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h2 id="modalTitle" class="win">&#127881; You Win!</h2>
            <div class="stats" id="modalStats">
                <div class="stat">
                    <div class="stat-val" id="statTime">00:00</div>
                    <div class="stat-label">Time</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="statMistakes">0</div>
                    <div class="stat-label">Mistakes</div>
                </div>
                <div class="stat">
                    <div class="stat-val" id="statHints">0</div>
                    <div class="stat-label">Hints</div>
                </div>
            </div>
            <p id="modalMsg">Great job!</p>
            <button id="modalBtn">New Game</button>
        </div>
    </div>

    <div class="confetti-container" id="confettiContainer"></div>

    <script>
        (() => {
            /* ============ STATE ============ */
            let solution = [];
            let puzzle = [];
            let board = [];
            let notes = [];
            let given = [];
            let originalGiven = [];
            let selectedCell = null;
            let notesMode = false;
            let mistakes = 0;
            let hintsUsed = 0;
            const maxMistakes = 3;
            let history = [];
            let timerInterval = null;
            let seconds = 0;
            let gameOver = false;
            let paused = false;

            const CLUES = { easy: 45, medium: 35, hard: 27, expert: 22 };

            /* ============ DOM REFS ============ */
            const $board = document.getElementById('board');
            const $numPad = document.getElementById('numPad');
            const $timer = document.getElementById('timer');
            const $mistakes = document.getElementById('mistakes');
            const $progressFill = document.getElementById('progressFill');
            const $progressText = document.getElementById('progressText');
            const $modal = document.getElementById('modal');
            const $modalTitle = document.getElementById('modalTitle');
            const $modalMsg = document.getElementById('modalMsg');
            const $notesBtn = document.getElementById('notesBtn');
            const $pauseBtn = document.getElementById('pauseBtn');
            const $pauseOverlay = document.getElementById('pauseOverlay');
            const $undoBtn = document.getElementById('undoBtn');
            const $confetti = document.getElementById('confettiContainer');

            /* ============ SUDOKU GENERATOR ============ */
            function generateSolution() {
                const grid = Array.from({ length: 9 }, () => Array(9).fill(0));

                function isValid(g, r, c, num) {
                    for (let i = 0; i < 9; i++) {
                        if (g[r][i] === num || g[i][c] === num) return false;
                    }
                    const br = (r / 3 | 0) * 3, bc = (c / 3 | 0) * 3;
                    for (let i = br; i < br + 3; i++)
                        for (let j = bc; j < bc + 3; j++)
                            if (g[i][j] === num) return false;
                    return true;
                }

                function fill(g) {
                    for (let r = 0; r < 9; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (g[r][c] === 0) {
                                const nums = shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9]);
                                for (const n of nums) {
                                    if (isValid(g, r, c, n)) {
                                        g[r][c] = n;
                                        if (fill(g)) return true;
                                        g[r][c] = 0;
                                    }
                                }
                                return false;
                            }
                        }
                    }
                    return true;
                }

                fill(grid);
                return grid;
            }

            function shuffle(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.random() * (i + 1) | 0;
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            }

            function generatePuzzle(sol, clueCount) {
                const p = sol.map(row => [...row]);
                const cells = [];
                for (let r = 0; r < 9; r++)
                    for (let c = 0; c < 9; c++)
                        cells.push([r, c]);
                shuffle(cells);
                let removed = 0;
                const toRemove = 81 - clueCount;
                for (const [r, c] of cells) {
                    if (removed >= toRemove) break;
                    p[r][c] = 0;
                    removed++;
                }
                return p;
            }

            /* ============ GAME INIT ============ */
            function newGame() {
                const diff = document.getElementById('difficulty').value;
                solution = generateSolution();
                puzzle = generatePuzzle(solution, CLUES[diff]);
                board = puzzle.map(row => [...row]);
                given = puzzle.map(row => row.map(v => v !== 0));
                originalGiven = given.map(row => [...row]);
                notes = Array.from({ length: 9 }, () =>
                    Array.from({ length: 9 }, () => new Set())
                );
                selectedCell = null;
                notesMode = false;
                mistakes = 0;
                hintsUsed = 0;
                history = [];
                gameOver = false;
                paused = false;
                seconds = 0;
                clearInterval(timerInterval);
                timerInterval = setInterval(tick, 1000);
                $pauseBtn.textContent = '\u23F8';
                $pauseOverlay.classList.remove('show');
                updateNotesBtn();
                updateUndoBtn();
                render();
            }

            /* ============ TIMER ============ */
            function tick() {
                if (paused || gameOver) return;
                seconds++;
                updateTimerDisplay();
            }

            function updateTimerDisplay() {
                $timer.textContent = formatTime(seconds);
            }

            function formatTime(secs) {
                const m = String(secs / 60 | 0).padStart(2, '0');
                const s = String(secs % 60).padStart(2, '0');
                return m + ':' + s;
            }

            /* ============ PAUSE ============ */
            function togglePause() {
                if (gameOver) return;
                paused = !paused;
                $pauseBtn.textContent = paused ? '\u25B6' : '\u23F8';
                if (paused) {
                    $pauseOverlay.classList.add('show');
                } else {
                    $pauseOverlay.classList.remove('show');
                }
            }

            /* ============ RENDER ============ */
            function render() {
                renderBoard();
                renderNumPad();
                renderProgress();
                $mistakes.textContent = mistakes;
            }

            function renderBoard() {
                $board.innerHTML = '';
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;

                        const val = board[r][c];
                        const isGiven = given[r][c];
                        const isSelected = selectedCell && selectedCell.r === r && selectedCell.c === c;
                        const selVal = selectedCell ? board[selectedCell.r][selectedCell.c] : 0;
                        const isHighlight = selectedCell && (
                            selectedCell.r === r ||
                            selectedCell.c === c ||
                            ((selectedCell.r / 3 | 0) === (r / 3 | 0) &&
                                (selectedCell.c / 3 | 0) === (c / 3 | 0))
                        );
                        const isSameNum = selectedCell && val !== 0 && selVal === val && !isSelected;
                        const isError = val !== 0 && !isGiven && val !== solution[r][c];

                        if (isHighlight) cell.classList.add('highlight');
                        if (isSameNum) cell.classList.add('same-num');
                        if (isSelected) cell.classList.add('selected');
                        if (isGiven) cell.classList.add('given');
                        else if (val !== 0) cell.classList.add('user');
                        if (isError) cell.classList.add('error');

                        if (val !== 0) {
                            cell.textContent = val;
                        } else if (notes[r][c].size > 0) {
                            const ng = document.createElement('div');
                            ng.className = 'notes-grid';
                            for (let n = 1; n <= 9; n++) {
                                const sp = document.createElement('span');
                                sp.textContent = notes[r][c].has(n) ? n : '';
                                ng.appendChild(sp);
                            }
                            cell.appendChild(ng);
                        }

                        cell.addEventListener('click', () => selectCell(r, c));
                        $board.appendChild(cell);
                    }
                }
            }

            function renderNumPad() {
                $numPad.innerHTML = '';
                const selVal = selectedCell ? board[selectedCell.r][selectedCell.c] : 0;
                for (let n = 1; n <= 9; n++) {
                    const btn = document.createElement('button');
                    btn.className = 'num-btn';

                    let count = 0;
                    for (let r = 0; r < 9; r++)
                        for (let c = 0; c < 9; c++)
                            if (board[r][c] === n) count++;

                    if (count >= 9) {
                        btn.classList.add('depleted');
                    }

                    if (selVal === n && selVal !== 0) {
                        btn.classList.add('active-num');
                    }

                    const badge = document.createElement('span');
                    badge.className = 'count-badge';
                    badge.textContent = 9 - count;
                    btn.appendChild(badge);

                    const numText = document.createTextNode(n);
                    btn.prepend(numText);

                    btn.addEventListener('click', () => placeNumber(n));
                    $numPad.appendChild(btn);
                }
            }

            function renderProgress() {
                let filled = 0;
                for (let r = 0; r < 9; r++)
                    for (let c = 0; c < 9; c++)
                        if (board[r][c] !== 0 && board[r][c] === solution[r][c]) filled++;
                const pct = (filled / 81 * 100).toFixed(1);
                $progressFill.style.width = pct + '%';
                $progressText.textContent = filled + ' / 81';
            }

            /* ============ INTERACTIONS ============ */
            function selectCell(r, c) {
                if (gameOver || paused) return;
                selectedCell = { r: r, c: c };
                render();
            }

            function placeNumber(num) {
                if (gameOver || paused || !selectedCell) return;
                var r = selectedCell.r, c = selectedCell.c;
                if (given[r][c]) return;

                if (notesMode) {
                    if (board[r][c] !== 0) return;
                    var prev = new Set(notes[r][c]);
                    if (notes[r][c].has(num)) {
                        notes[r][c].delete(num);
                    } else {
                        notes[r][c].add(num);
                    }
                    history.push({ type: 'note', r: r, c: c, prev: prev, val: board[r][c] });
                    updateUndoBtn();
                    render();
                    return;
                }

                if (board[r][c] === num) return;

                var prevVal = board[r][c];
                var prevNotes = new Set(notes[r][c]);
                var removedPeerNotes = [];

                board[r][c] = num;
                notes[r][c].clear();

                var seenPeers = {};
                function removePeerNote(pr, pc) {
                    var key = pr * 9 + pc;
                    if (seenPeers[key]) return;
                    seenPeers[key] = true;
                    if (notes[pr][pc].has(num)) {
                        notes[pr][pc].delete(num);
                        removedPeerNotes.push({ r: pr, c: pc, num: num });
                    }
                }
                for (var i = 0; i < 9; i++) {
                    removePeerNote(r, i);
                    removePeerNote(i, c);
                }
                var br = (r / 3 | 0) * 3, bc = (c / 3 | 0) * 3;
                for (var ii = br; ii < br + 3; ii++)
                    for (var jj = bc; jj < bc + 3; jj++)
                        removePeerNote(ii, jj);

                var wasWrong = false;
                if (num !== solution[r][c]) {
                    mistakes++;
                    wasWrong = true;
                    if (mistakes >= maxMistakes) {
                        history.push({ type: 'place', r: r, c: c, prevVal: prevVal, prevNotes: prevNotes, removedPeerNotes: removedPeerNotes, wasWrong: true });
                        gameOver = true;
                        clearInterval(timerInterval);
                        render();
                        showModal(false);
                        return;
                    }
                }

                history.push({ type: 'place', r: r, c: c, prevVal: prevVal, prevNotes: prevNotes, removedPeerNotes: removedPeerNotes, wasWrong: wasWrong });
                updateUndoBtn();
                render();

                if (!wasWrong) {
                    animateCellPop(r, c);
                }

                checkWin();
            }

            function erase() {
                if (gameOver || paused || !selectedCell) return;
                var r = selectedCell.r, c = selectedCell.c;
                if (given[r][c]) return;
                if (board[r][c] === 0 && notes[r][c].size === 0) return;

                var prevVal = board[r][c];
                var prevNotes = new Set(notes[r][c]);
                history.push({ type: 'erase', r: r, c: c, prevVal: prevVal, prevNotes: prevNotes });

                board[r][c] = 0;
                notes[r][c].clear();
                updateUndoBtn();
                render();
            }

            function undo() {
                if (gameOver || paused || history.length === 0) return;
                var action = history.pop();
                var r = action.r, c = action.c;

                if (action.type === 'place') {
                    board[r][c] = action.prevVal;
                    notes[r][c] = new Set(action.prevNotes);
                    if (action.wasWrong) {
                        mistakes = Math.max(0, mistakes - 1);
                    }
                    if (action.removedPeerNotes) {
                        for (var i = 0; i < action.removedPeerNotes.length; i++) {
                            var pn = action.removedPeerNotes[i];
                            notes[pn.r][pn.c].add(pn.num);
                        }
                    }
                } else if (action.type === 'erase') {
                    board[r][c] = action.prevVal;
                    notes[r][c] = new Set(action.prevNotes);
                } else if (action.type === 'note') {
                    notes[r][c] = new Set(action.prev);
                    board[r][c] = action.val;
                } else if (action.type === 'hint') {
                    board[r][c] = action.prevVal;
                    notes[r][c] = new Set(action.prevNotes);
                    given[r][c] = action.wasGivenBefore;
                    hintsUsed = Math.max(0, hintsUsed - 1);
                    if (action.removedPeerNotes) {
                        for (var j = 0; j < action.removedPeerNotes.length; j++) {
                            var pn2 = action.removedPeerNotes[j];
                            notes[pn2.r][pn2.c].add(pn2.num);
                        }
                    }
                }

                updateUndoBtn();
                render();
            }

            function giveHint() {
                if (gameOver || paused) return;
                var empties = [];
                for (var r = 0; r < 9; r++)
                    for (var c = 0; c < 9; c++)
                        if (board[r][c] !== solution[r][c])
                            empties.push([r, c]);

                if (empties.length === 0) return;
                var pick = empties[Math.random() * empties.length | 0];
                var hr = pick[0], hc = pick[1];

                var prevVal = board[hr][hc];
                var prevNotes = new Set(notes[hr][hc]);

                var removedPeerNotes = [];
                var num = solution[hr][hc];
                var seenPeers = {};
                function removePeerNote(pr, pc) {
                    var key = pr * 9 + pc;
                    if (seenPeers[key]) return;
                    seenPeers[key] = true;
                    if (notes[pr][pc].has(num)) {
                        notes[pr][pc].delete(num);
                        removedPeerNotes.push({ r: pr, c: pc, num: num });
                    }
                }

                board[hr][hc] = num;
                notes[hr][hc].clear();

                for (var i = 0; i < 9; i++) {
                    removePeerNote(hr, i);
                    removePeerNote(i, hc);
                }
                var br = (hr / 3 | 0) * 3, bc = (hc / 3 | 0) * 3;
                for (var ii = br; ii < br + 3; ii++)
                    for (var jj = bc; jj < bc + 3; jj++)
                        removePeerNote(ii, jj);

                var wasGivenBefore = originalGiven[hr][hc];
                given[hr][hc] = true;
                hintsUsed++;

                history.push({
                    type: 'hint', r: hr, c: hc, prevVal: prevVal, prevNotes: prevNotes,
                    removedPeerNotes: removedPeerNotes, wasGivenBefore: wasGivenBefore
                });

                selectedCell = { r: hr, c: hc };
                updateUndoBtn();
                render();

                var idx = hr * 9 + hc;
                var cellEl = $board.children[idx];
                if (cellEl) cellEl.classList.add('hint-flash');

                checkWin();
            }

            function toggleNotes() {
                if (gameOver || paused) return;
                notesMode = !notesMode;
                updateNotesBtn();
            }

            function updateNotesBtn() {
                if (notesMode) $notesBtn.classList.add('active');
                else $notesBtn.classList.remove('active');
            }

            function updateUndoBtn() {
                $undoBtn.disabled = history.length === 0;
            }

            function animateCellPop(r, c) {
                var idx = r * 9 + c;
                var cellEl = $board.children[idx];
                if (cellEl) {
                    cellEl.classList.add('pop');
                    cellEl.addEventListener('animationend', function handler() {
                        cellEl.classList.remove('pop');
                        cellEl.removeEventListener('animationend', handler);
                    });
                }
            }

            /* ============ WIN / LOSE ============ */
            function checkWin() {
                for (var r = 0; r < 9; r++)
                    for (var c = 0; c < 9; c++)
                        if (board[r][c] !== solution[r][c]) return;
                gameOver = true;
                clearInterval(timerInterval);
                showModal(true);
                launchConfetti();
            }

            function showModal(isWin) {
                $modalTitle.textContent = isWin ? '\uD83C\uDF89 You Win!' : '\uD83D\uDE1E Game Over';
                $modalTitle.className = isWin ? 'win' : 'lose';

                document.getElementById('statTime').textContent = formatTime(seconds);
                document.getElementById('statMistakes').textContent = mistakes;
                document.getElementById('statHints').textContent = hintsUsed;

                if (isWin) {
                    var diff = document.getElementById('difficulty').value;
                    var diffLabel = diff.charAt(0).toUpperCase() + diff.slice(1);
                    $modalMsg.textContent = diffLabel + ' puzzle solved!';
                } else {
                    $modalMsg.textContent = 'You made 3 mistakes. Better luck next time!';
                }

                $modal.classList.add('show');
            }

            function hideModal() {
                $modal.classList.remove('show');
            }

            /* ============ CONFETTI ============ */
            function launchConfetti() {
                $confetti.innerHTML = '';
                var colors = ['#60a5fa', '#a78bfa', '#34d399', '#fbbf24', '#f87171', '#fb923c', '#e879f9'];
                for (var i = 0; i < 80; i++) {
                    var piece = document.createElement('div');
                    piece.className = 'confetti';
                    piece.style.left = (Math.random() * 100) + '%';
                    piece.style.top = (-10 - Math.random() * 20) + '%';
                    piece.style.background = colors[Math.random() * colors.length | 0];
                    piece.style.width = (5 + Math.random() * 8) + 'px';
                    piece.style.height = (5 + Math.random() * 8) + 'px';
                    piece.style.animationDuration = (1.5 + Math.random() * 2) + 's';
                    piece.style.animationDelay = (Math.random() * 0.8) + 's';
                    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                    $confetti.appendChild(piece);
                }
                setTimeout(function () { $confetti.innerHTML = ''; }, 4500);
            }

            /* ============ KEYBOARD ============ */
            document.addEventListener('keydown', function (e) {
                if (gameOver) return;

                if (e.key === 'p' || e.key === 'P') {
                    togglePause();
                    return;
                }
                if (paused) return;

                var num = parseInt(e.key);
                if (num >= 1 && num <= 9) {
                    placeNumber(num);
                    return;
                }
                if (e.key === 'Backspace' || e.key === 'Delete') {
                    erase();
                    return;
                }
                if (e.key === 'n' || e.key === 'N') {
                    toggleNotes();
                    return;
                }
                if (e.key === 'h' || e.key === 'H') {
                    giveHint();
                    return;
                }
                if ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    undo();
                    return;
                }
                if (e.key.indexOf('Arrow') === 0) {
                    e.preventDefault();
                    if (!selectedCell) {
                        selectCell(0, 0);
                        return;
                    }
                    var sr = selectedCell.r, sc = selectedCell.c;
                    if (e.key === 'ArrowUp') sr = Math.max(0, sr - 1);
                    else if (e.key === 'ArrowDown') sr = Math.min(8, sr + 1);
                    else if (e.key === 'ArrowLeft') sc = Math.max(0, sc - 1);
                    else if (e.key === 'ArrowRight') sc = Math.min(8, sc + 1);
                    selectCell(sr, sc);
                }
            });

            /* ============ BUTTON BINDINGS ============ */
            $undoBtn.addEventListener('click', undo);
            document.getElementById('eraseBtn').addEventListener('click', erase);
            $notesBtn.addEventListener('click', toggleNotes);
            document.getElementById('hintBtn').addEventListener('click', giveHint);
            document.getElementById('newGameBtn').addEventListener('click', function () {
                hideModal();
                newGame();
            });
            document.getElementById('modalBtn').addEventListener('click', function () {
                hideModal();
                newGame();
            });
            document.getElementById('difficulty').addEventListener('change', function () {
                hideModal();
                newGame();
            });
            $pauseBtn.addEventListener('click', togglePause);
            $pauseOverlay.addEventListener('click', togglePause);

            $modal.addEventListener('click', function (e) {
                if (e.target === e.currentTarget) hideModal();
            });

            /* ============ START ============ */
            newGame();
        })();
    </script>
</body>

</html>